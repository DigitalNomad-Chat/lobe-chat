# 🚀 LobeChat 自定义版本宝塔面板部署教程

本教程将指导你如何在宝塔面板上部署自定义修改的 LobeChat 项目。

## 📋 方案概述

LobeChat 是一个基于 Next.js 15 的全栈 AI 聊天应用，支持两种部署模式：
- **客户端数据库模式**：数据存储在浏览器本地，适合个人使用
- **服务端数据库模式**：完整功能，需要 PostgreSQL + S3 + 认证服务

## 🛠️ 技术架构

**核心技术栈：**
- **框架**: Next.js 15 (App Router)
- **运行时**: Node.js 22
- **包管理**: pnpm + bun
- **数据库**: PostgreSQL + PGLite
- **认证**: NextAuth.js
- **UI**: React 19 + Antd + @lobehub/ui

## 📋 环境要求

**服务器要求：**
- **系统**: Linux (推荐 Ubuntu 20.04+)
- **内存**: 最低 2GB，推荐 4GB+
- **存储**: 最低 10GB 可用空间
- **Node.js**: 22.x 版本

**宝塔面板版本：**
- 宝塔面板 7.x 或更高版本
- 支持 Node.js 项目管理

## 🎯 部署方案

### 方案一：Node.js 网站部署（推荐）

这是最直接的方案，将 LobeChat 作为 Node.js 应用部署在宝塔面板上。

## 📖 详细部署教程

### 准备阶段

#### 1. Fork 并克隆项目

```bash
# 1. Fork https://github.com/lobehub/lobe-chat 到你的 GitHub 账号

# 2. 克隆你的 fork 版本
git clone https://github.com/your-username/lobe-chat.git
cd lobe-chat

# 3. 进行你的自定义修改
# ... 修改代码 ...

# 4. 提交修改
git add .
git commit -m "Custom modifications"
git push origin main
```

#### 2. 服务器环境准备

在宝塔面板软件商店安装以下软件：
- **Node.js 版本管理器**
- **PM2 管理器**
- **Nginx** (用于反向代理)
- **PostgreSQL** (如果使用服务端数据库)

### 第一步：环境配置

#### 1. Node.js 环境设置

```bash
# 方法一：通过宝塔面板 Node.js 版本管理器安装 22.x 版本

# 方法二：命令行安装（推荐）
curl -fsSL https://fnm.vercel.app/install | bash
source ~/.bashrc
fnm install 22
fnm use 22

# 安装全局依赖
npm install -g pnpm@latest bun
```

#### 2. 创建网站

在宝塔面板中：
1. 点击 "网站" → "添加站点"
2. 选择 "Node.js" 类型
3. 设置域名（如：`chat.yourdomain.com`）
4. 选择 Node.js 版本：22.x

### 第二步：项目部署

#### 1. 上传项目代码

```bash
# 进入网站根目录
cd /www/wwwroot/chat.yourdomain.com

# 克隆你的自定义项目
git clone https://github.com/your-username/lobe-chat.git .

# 或者通过宝塔面板文件管理器上传代码
```

#### 2. 安装依赖和构建

```bash
# 安装依赖
pnpm install

# 构建项目（生产环境）
pnpm run build

# 验证构建结果
ls -la .next/standalone/
```

#### 3. 环境变量配置

在项目根目录创建 `.env.local` 文件：

```env
# 基础配置
NODE_ENV=production
PORT=3210
HOSTNAME=0.0.0.0

# OpenAI 配置
OPENAI_API_KEY=your_openai_api_key
OPENAI_PROXY_URL=https://api.openai.com/v1

# 访问控制（可选）
ACCESS_CODE=your_access_code

# 如果使用服务端数据库
DATABASE_URL=postgresql://username:password@localhost:5432/lobechat
NEXT_AUTH_SECRET=your_nextauth_secret
NEXT_AUTH_URL=https://chat.yourdomain.com

# S3 存储配置（可选）
S3_ENDPOINT=https://your-s3-endpoint
S3_BUCKET=lobechat
S3_ACCESS_KEY_ID=your_access_key
S3_SECRET_ACCESS_KEY=your_secret_key

# 其他 AI 提供商配置（根据需要添加）
ANTHROPIC_API_KEY=your_anthropic_key
GOOGLE_API_KEY=your_google_key
```

### 第三步：宝塔面板配置

#### 1. Node.js 项目设置

在宝塔面板 → 网站 → 你的站点 → 设置：

```
项目类型: Node.js
Node版本: 22.x
项目路径: /www/wwwroot/chat.yourdomain.com
启动文件: .next/standalone/server.js
运行目录: /www/wwwroot/chat.yourdomain.com
端口: 3210
```

#### 2. PM2 进程管理配置

在项目根目录创建 `ecosystem.config.js`：

```javascript
module.exports = {
  apps: [{
    name: 'lobe-chat',
    script: '.next/standalone/server.js',
    cwd: '/www/wwwroot/chat.yourdomain.com',
    instances: 1,
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3210,
      HOSTNAME: '0.0.0.0'
    },
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_file: './logs/combined.log',
    time: true,
    max_memory_restart: '2G'
  }]
}
```

启动应用：

```bash
# 创建日志目录
mkdir -p logs

# 启动应用
pm2 start ecosystem.config.js

# 保存 PM2 配置
pm2 save

# 设置开机自启
pm2 startup
```

#### 3. Nginx 反向代理配置

在宝塔面板网站设置 → 反向代理中添加：

```nginx
# 代理名称：LobeChat
# 目标URL：http://127.0.0.1:3210
# 发送域名：$host
# 内容替换：留空

# 高级配置
location / {
    proxy_pass http://127.0.0.1:3210;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_cache_bypass $http_upgrade;
    
    # 支持 Server-Sent Events (流式响应)
    proxy_buffering off;
    proxy_read_timeout 86400;
    proxy_send_timeout 86400;
    
    # 文件上传大小限制
    client_max_body_size 100M;
}

# 静态文件优化
location /_next/static/ {
    alias /www/wwwroot/chat.yourdomain.com/.next/static/;
    expires 1y;
    add_header Cache-Control "public, immutable";
}

location /images/ {
    alias /www/wwwroot/chat.yourdomain.com/public/images/;
    expires 1y;
    add_header Cache-Control "public, immutable";
}

location /icons/ {
    alias /www/wwwroot/chat.yourdomain.com/public/icons/;
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

### 第四步：数据库配置（可选）

如果需要服务端数据库功能：

#### 1. PostgreSQL 设置

```sql
-- 在宝塔面板 PostgreSQL 管理中执行
CREATE DATABASE lobechat;
CREATE USER lobechat_user WITH PASSWORD 'your_strong_password';
GRANT ALL PRIVILEGES ON DATABASE lobechat TO lobechat_user;

-- 连接到 lobechat 数据库
\c lobechat;

-- 安装 pgvector 扩展（用于向量搜索）
CREATE EXTENSION IF NOT EXISTS vector;
```

#### 2. 数据库迁移

```bash
# 运行数据库迁移
pnpm run db:migrate
```

### 第五步：SSL 证书配置

#### 1. 申请 SSL 证书

在宝塔面板中：
1. 进入网站设置 → SSL
2. 选择 "Let's Encrypt" 免费证书
3. 填写邮箱地址
4. 点击申请证书
5. 开启 "强制HTTPS"

#### 2. 更新环境变量

更新 `.env.local` 中的 `NEXT_AUTH_URL`：
```env
NEXT_AUTH_URL=https://chat.yourdomain.com
```

### 第六步：监控和维护

#### 1. 应用监控

```bash
# 查看应用状态
pm2 status

# 查看应用日志
pm2 logs lobe-chat

# 查看实时日志
pm2 logs lobe-chat --lines 100

# 监控应用资源使用
pm2 monit
```

#### 2. 自动更新脚本

创建 `update.sh` 脚本：

```bash
#!/bin/bash

echo "开始更新 LobeChat..."

# 进入项目目录
cd /www/wwwroot/chat.yourdomain.com

# 停止应用
pm2 stop lobe-chat

# 备份当前版本
cp -r .next .next.backup.$(date +%Y%m%d_%H%M%S)

# 拉取最新代码
git pull origin main

# 安装依赖
pnpm install

# 重新构建
pnpm run build

# 数据库迁移（如果有）
pnpm run db:migrate

# 启动应用
pm2 start lobe-chat

# 等待应用启动
sleep 10

# 检查应用状态
pm2 status lobe-chat

echo "LobeChat 更新完成！"
```

设置执行权限：
```bash
chmod +x update.sh
```

#### 3. 定时任务

在宝塔面板 → 计划任务中添加：

```bash
# 每天凌晨 3 点重启应用（保持最佳性能）
0 3 * * * pm2 restart lobe-chat

# 每周清理日志文件
0 2 * * 0 pm2 flush lobe-chat

# 每月清理 npm 缓存
0 1 1 * * pnpm store prune
```

## 🔧 高级配置

### 1. 性能优化

#### 内存优化
```javascript
// ecosystem.config.js 中添加
env: {
  NODE_OPTIONS: '--max-old-space-size=4096',
  // 其他环境变量...
}
```

#### 缓存配置
```nginx
# 在 Nginx 配置中添加缓存
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    add_header Vary Accept-Encoding;
    gzip_static on;
}
```

### 2. 安全配置

#### 防火墙设置
在宝塔面板 → 安全中：
- 只开放必要端口：80, 443, SSH端口
- 关闭 3210 端口的外网访问（通过 Nginx 代理访问）

#### 访问控制
```env
# .env.local 中设置访问密码
ACCESS_CODE=your_strong_access_code
```

### 3. 备份策略

#### 数据备份脚本
```bash
#!/bin/bash
# backup.sh

BACKUP_DIR="/www/backup/lobe-chat"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
pg_dump lobechat > $BACKUP_DIR/database_$DATE.sql

# 备份用户上传文件（如果有）
tar -czf $BACKUP_DIR/uploads_$DATE.tar.gz /www/wwwroot/chat.yourdomain.com/public/uploads

# 清理 7 天前的备份
find $BACKUP_DIR -name "*.sql" -mtime +7 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete

echo "备份完成: $DATE"
```

## ⚠️ 常见问题

### 1. 构建失败

**问题**: `pnpm run build` 失败
**解决方案**:
```bash
# 清理缓存重新安装
rm -rf node_modules .next
pnpm install
pnpm run build
```

### 2. 应用无法启动

**问题**: PM2 启动失败
**解决方案**:
```bash
# 检查端口占用
netstat -tlnp | grep 3210

# 检查 Node.js 版本
node --version

# 查看详细错误日志
pm2 logs lobe-chat --err
```

### 3. 内存不足

**问题**: 应用因内存不足被杀死
**解决方案**:
```bash
# 增加 swap 空间
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# 或者升级服务器配置
```

### 4. SSL 证书问题

**问题**: HTTPS 访问失败
**解决方案**:
1. 检查域名解析是否正确
2. 确保 80 和 443 端口开放
3. 重新申请 SSL 证书

## 📞 技术支持

如果在部署过程中遇到问题：

1. **查看日志**: `pm2 logs lobe-chat`
2. **检查配置**: 确认环境变量和端口设置
3. **资源监控**: `pm2 monit` 检查内存和 CPU 使用
4. **重启应用**: `pm2 restart lobe-chat`

## 🎉 部署完成

完成以上步骤后，你的自定义 LobeChat 就成功部署在宝塔面板上了！

**访问地址**: `https://chat.yourdomain.com`

**管理方式**:
- **应用管理**: 通过 PM2 或宝塔面板 Node.js 管理
- **日志查看**: `pm2 logs lobe-chat`
- **性能监控**: `pm2 monit`
- **SSL 管理**: 宝塔面板 SSL 设置

现在你可以享受完全自定义的 LobeChat 体验了！

---

**最后更新**: 2024年1月
**适用版本**: LobeChat v1.x
**宝塔面板版本**: 7.x+
